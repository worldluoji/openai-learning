# Sampler
我们学习过 WebUI，你会发现里面有多种可供选择的采样器方法，包括 Euler a、DPM、DDIM 等等。

基于扩散模型的AI绘图，采样器存在的价值就是从噪声出发，逐步去噪，得到一张清晰的图像。


## 采样器基本原理
UNet 模型负责预测要去除的噪声。UNet 模型的输入是时间步 t 对应的噪声图像 xt 和时间步 t 的编码。、UNet 的输出的不是上一个时间步 t-1 的噪声图像，而是上一个时间步添加的噪声值ϵt-1.

我们需要结合噪声图像 x_t，时间步 t-1 的噪声 ϵt-1，去获取上一个时间步 t-1 的噪声图像 xt-1.
对于经典的 DDPM 采样器而言， xt−1​ 可以通过下面的公式来进行计算。

<img src="./images/DDPM Sampler.png" />

公式中的 αt​，σt​ 和 z 都是已知的数值。整个过程重复多次，最终你将获得一个干净的图像。这个去噪过程称为采样，采样中使用的方法被称为采样器或采样方法。在 [DDPM 的论文](https://arxiv.org/abs/2006.11239)中使用大量篇幅推导采样器的计算公式，感兴趣的同学可以翻阅原始论文。

对于绝大多数 AI 绘画的工作场景，我们只需要掌握各种**采样器的特性**即可，不需要熟练掌握采样器背后的推导过程。各种不同的采样器，在表现形式上便是不同的 xt−1​ 计算公式。

简言之，UNet 负责预测噪声，采样器负责“减去”噪声。这个过程反复迭代，我们就能从噪声图 xt​ 得到 xt−1​，然后得到 xt−2​，最终得到 x0​，也就是清晰可辨的图像。

## 为什么在 WebUI 中不同采样器设置的步数会不同呢？
加噪的过程有 1000 步，那么是不是去噪过程也需要 1000 步呢？

如果我们使用训练过程的逻辑进行采样，也就是每次只去噪一步，那么在扩散模型中生成清晰图像确实需要进行 1000 步的采样，也就是 UNet 的运算要重复 1000 次。这种方法非常耗时且占用资源。

实际上，如果我们使用更“快速”的采样方法，例如 Euler a、DPM 等，只需要进行 20 步采样就能得到清晰的图像。在这种情况下，模型每次去噪的间隔时间步是 50 （1000/20），相当于一次去掉 50 个噪声，以跳跃的形式生成清晰的图像 x0​。

较少的步数意味着每个去噪步骤跨度更大。这种方法可以更高效地生成清晰图像，减少了计算量和时间消耗。

不同采样器之间的去噪过程就像是龟兔赛跑，**有的步子迈得大、有的迈得小**。那跑得快的采样器是如何更快实现这个过程的呢？其实也并不神秘，有点像我们高中看到一道复杂的应用题，经过一些数学变换，就变成更容易解决的“数学题”了。这个工程问题经过一系列数学变换，实际无非是解决一些随机微分方程（stochastic differential equations，SDE）和常微分方程（ordinary differential equations，ODE）的问题。

## WebUI 中怎样选择合适的采样器
老派采样器：
- Euler，可以看作是最简单的求解器。
- Heun，比欧拉法更准确但速度较慢。
- LMS (Linear multi-step method)，与欧拉法速度差不多，但（据说）更准确。

除了这三个老派采样器，你可能注意到还有一些采样器的名称中也有一个字母 a 呢？比如 Euler a、DPM2 a、DPM++ 2S a、DPM++ 2S a Karras，它们都属于祖先采样器（ancestral samplers）。祖先采样器会在每个采样步骤中向图像添加噪声。因为采样结果有一定的随机性，所以它们是随机采样器。

带有 “Karras” 标签的采样器。它们采用了 [Karras 文章](https://arxiv.org/abs/2206.00364)中推荐的噪声策略。在接近去噪过程结束时，将噪声步长变小。研究人员发现这可以提高图像的质量。

而 DDIM（去噪扩散隐式模型）和 PLMS（伪线性多步方法）是最初发布的 SD 模型 v1 中附带的采样器。不过，这两个采样器目前通常被认为已经过时，并且不再广泛使用。所以在 WebUI 中的位置也比较靠后。

DPM（扩散概率模型求解器）和 DPM++ 采样器是 2022 年发布的专为扩散模型设计的新采样器。带有 DPM 标志的采样器代表了一系列具有相似架构的求解器。

<img src="./images/sampler difference example1.webp" />

那么我们在实践中，该如何选择采样器呢？我给你提供几个选择采样器的建议。
- 如果你想使用快速、新颖且质量不错的算法，最好的选择是 DPM++ 2M Karras，设置 20~30 步。
- 如果你想要高质量的图像，那么可以考虑使用 DPM++ SDE Karras，设置 10~15 步，但要注意这是一个计算较慢的采样器。或者使用 DDIM 求解器，设置 10~15 步。
- 如果你喜欢稳定、可重现的图像，请避免使用任何原始采样器（SDE 类采样器）。
- 如果你喜欢简单算法，Euler 和 Heun 是不错的选择。